x-conf-dev-spark-job: &conf_dev_spark_streaming_job
  restart: on-failure
  networks:
    - vpc_dm
  build: ../../docker/app_layer/spark-streaming-jobs
  env_file:
    - ./conf/swarm.secrets.conf
    - ./conf/dev.kafka.conf
    - ./conf/dev.redis.conf
    - ./conf/dev.lakehouse.conf
  volumes:
    - ../../docker/app_layer/spark-streaming-jobs/src:/app
    - ../../docker/app_layer/spark-streaming-jobs/conf/spark-defaults.conf:/opt/bitnami/spark/conf/spark-defaults.conf

services:

  spark-app-apk-comsumption:
    <<: *conf_dev_spark_streaming_job
    container_name: spark-app-apk-comsumption
    entrypoint: "sh /app/entrypoint.sh /app/1_api_key_monitor.py"
    environment:
      TOPIC_LOGS: mainnet.0.application.logs
      CONSUMER_GROUP: cg_logs_processor
      STARTING_OFFSETS: earliest
      MAX_OFFSETS_PER_TRIGGER: 3000


  spark-app-multiplex-bronze:
    <<: *conf_dev_spark_streaming_job
    container_name: spark-app-multiplex-bronze
    entrypoint: "sh /app/entrypoint.sh /app/pyspark/2_job_bronze_multiplex.py"
    environment:
      CHECKPOINT_PATH: "s3a://spark/checkpoints/iceberg/kafka_topics_multiplexed"
      TOPICS: "mainnet.1.mined_blocks.data,mainnet.2.orphan_blocks.data,mainnet.4.mined.txs.raw_data"
      CONSUMER_GROUP: cg_bronze_1
      STARTING_OFFSETS: earliest
      MAX_OFFSETS_PER_TRIGGER: 10000
      TABLE_BRONZE: "nessie.bronze.kafka_topics_multiplexed"


  spark-app-silver-blocks:
    <<: *conf_dev_spark_streaming_job
    container_name: spark-app-silver-blocks
    entrypoint: "sh /app/entrypoint.sh /app/pyspark/3_job_silver_blocks.py"
    environment:
      CHECKPOINT_PATH: "s3a://spark/checkpoints/iceberg/blocks"
      TOPIC_BLOCKS: "mainnet.1.mined_blocks.data"
      TABLE_BRONZE: "nessie.bronze.kafka_topics_multiplexed"
      TABLE_SILVER_BLOCKS: "nessie.silver.blocks"
      TABLE_SILVER_BLOCKS_TXS: "nessie.silver.blocks_transactions"


  spark-app-silver-txs:
    <<: *conf_dev_spark_streaming_job
    container_name: spark-app-silver-txs
    #entrypoint: "sh /app/entrypoint.sh /app/pyspark/4_job_silver_transactions.py"
    environment:
      CHECKPOINT_PATH: "s3a://spark/checkpoints/iceberg/transactions"
      TOPIC_TXS: "mainnet.4.mined.txs.raw_data"
      TABLE_BRONZE: "nessie.bronze.kafka_topics_multiplexed"
      SILVER_TXS_P2P: "nessie.silver.transactions_p2p"
      SILVER_TXS_CONTRACTS: "nessie.silver.transactions_contracts"
      TABLE_SILVER_TXS: "nessie.silver.transactions"
      EXEC_MEMORY: 1g
      NUM_EXECUTORS: 2
      TOTAL_EXEC_CORES: 2



networks:
  vpc_dm:
    external: true